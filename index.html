<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Analyzer - Team Version (Google Sheets Backend)</title>
    <style>
        /* --- Comprehensive CSS Styling --- */
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 1200px; margin: auto;}
        h1, h2, h3 { color: #333; text-align: center; margin-bottom: 1em;}
        fieldset { border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px; padding: 15px; }
        legend { font-weight: bold; padding: 0 10px; font-size: 1.1em; color: #0056b3; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 20px; }
        .grid-col-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 20px; align-items: start;}
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em;}
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group select {
            padding: 8px; border: 1px solid #ddd; border-radius: 4px;
            box-sizing: border-box; font-size: 0.95em; width: 100%;
        }
        .input-with-toggle { display: flex; align-items: center; gap: 5px; }
        .input-with-toggle input[type="number"] { flex-grow: 1; width: auto; }
        .input-with-toggle select { width: 100px; flex-shrink: 0; }
        .asset-detail-label { font-size: 0.8em; color: #555; margin-top: 3px; display: block; }

        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button.delete-button { background-color: #dc3545; }
        button.delete-button:hover:not(:disabled) { background-color: #c82333; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }

        #resultsTable { margin-top: 20px; width: 100%; border-collapse: collapse; font-size: 0.85em; }
        #resultsTable th, #resultsTable td { border: 1px solid #ddd; padding: 5px 7px; text-align: right; }
        #resultsTable th { background-color: #f0f0f0; text-align: center; white-space: nowrap;}
        .pre-retirement-row { background-color: #e9f5ff; }
        .retirement-row { background-color: #fff8e1; }
        .message { padding: 10px; margin-bottom: 15px; border-radius: 4px; font-weight: bold; text-align: center; display: none; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; display: block; }
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; display: block; }
        .info { color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; display: block; }

        .summary { margin-top: 20px; padding: 15px; background-color: #e9f5ff; border-left: 5px solid #007bff; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        .positive { color: green; } .negative { color: red; font-weight: bold; }
        #resultsTable td.status-col { text-align: left; }

        .save-load-section { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 20px; border-radius: 5px; text-align: center; }
        .save-load-section .input-group { max-width: 300px; margin-left: auto; margin-right: auto;}
        .save-load-section label { display: inline-block; margin-right: 10px; }
        .save-load-section select { display: inline-block; width: auto; min-width: 150px; margin-right: 10px; }
        .save-load-controls { margin-top: 10px; }

        .action-buttons-container { text-align: center; margin-top: 20px; }
        #chartContainer { margin-top: 30px; padding: 15px; background-color: #fff; border: 1px solid #ddd; border-radius: 5px; display: none; max-width: 100%; box-sizing: border-box; }
        #projectionChart { max-width: 100%; height: auto; }
        .output-toggle-container { margin-bottom: 10px; text-align: right; }
        .output-toggle-container label { font-weight: bold; margin-right: 5px; }
        .spouse-section.hidden { display: none !important; }
        .spouse-column.hidden { display: none !important; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Retirement Analyzer - Team Version (Google Sheets Backend)</h1>
        <div id="message-area" class="message info">Ready. Fill in inputs or load a saved client.</div>

        <div class="save-load-section">
            <h3>Client Data Management</h3>
            <div class="input-group"> <label for="singleClientMode"><input type="checkbox" id="singleClientMode" onchange="toggleSpouseFields()"> Single Client (No Spouse Data)</label> </div>
            <hr style="margin: 10px auto; width: 80%;">
            <p style="font-size:0.8em; color: #666;">Data is stored in a central Google Sheet via Apps Script.</p>
            <div class="input-group"> <label for="clientNameId"><strong>Client Name/ID:</strong></label> <input type="text" id="clientNameId" placeholder="Enter Unique Client Name/ID"> </div>
            <div class="save-load-controls"> <button type="button" onclick="saveClientData()">Save</button> <label for="savedClients">Load:</label> <select id="savedClients"> <option value="">-- Select --</option> </select> <button type="button" onclick="loadClientData()">Load</button> <button type="button" class="delete-button" onclick="deleteClientData()">Delete</button> </div>
        </div>

        <form id="retirementForm">
            <div class="grid-col-2">
                <fieldset> <legend>Client Information</legend> <div class="input-group"> <label for="clientDOB">DOB:</label> <input type="date" id="clientDOB"> </div> <div class="input-group"> <label for="clientAge">Age (auto-calc or enter):</label> <input type="number" id="clientAge" value=""> </div> <div class="input-group"> <label for="clientIncome">Current Income ($):</label> <div class="input-with-toggle"> <input type="number" id="clientIncome" value="0"> <select id="clientIncomeFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <div class="input-group"> <label for="clientRetirementAge">Retirement Age:</label> <input type="number" id="clientRetirementAge" value="65"> </div> <div class="input-group"> <label for="clientPension">Est. Pension (Amount at Pension Start Age):</label> <div class="input-with-toggle"> <input type="number" id="clientPension" value="0"> <select id="clientPensionFreq"> <option value="annual" selected>Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <div class="input-group"> <label for="clientPensionStartAge">Pension Start Age:</label> <input type="number" id="clientPensionStartAge" value="65"> </div> <div class="input-group"> <label for="clientSS">Est. Social Security (Amount at SS Start Age):</label> <div class="input-with-toggle"> <input type="number" id="clientSS" value="0"> <select id="clientSSFreq"> <option value="annual" selected>Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <div class="input-group"> <label for="clientSSStartAge">Social Security Start Age:</label> <input type="number" id="clientSSStartAge" value="67"> </div> <div class="input-group"> <label for="clientYOS">Current Years of Service:</label> <input type="number" id="clientYOS" value="0"> </div> </fieldset>
                <fieldset class="spouse-section"> <legend>Spouse Information</legend> <div class="input-group"> <label for="spouseDOB">Spouse DOB:</label> <input type="date" id="spouseDOB"> </div> <div class="input-group"> <label for="spouseAge">Spouse Age (auto-calc):</label> <input type="number" id="spouseAge" value=""> </div> <div class="input-group"> <label for="spouseIncome">Spouse Current Income ($):</label> <div class="input-with-toggle"> <input type="number" id="spouseIncome" value="0"> <select id="spouseIncomeFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <div class="input-group"> <label for="spouseRetirementAge">Spouse Retirement Age:</label> <input type="number" id="spouseRetirementAge" value="65"> </div> <div class="input-group"> <label for="spousePension">Spouse Est. Pension (Amount at Pension Start Age):</label> <div class="input-with-toggle"> <input type="number" id="spousePension" value="0"> <select id="spousePensionFreq"> <option value="annual" selected>Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <div class="input-group"> <label for="spousePensionStartAge">Spouse Pension Start Age:</label> <input type="number" id="spousePensionStartAge" value="65"> </div> <div class="input-group"> <label for="spouseSS">Spouse Est. Social Security (Amount at SS Start Age):</label> <div class="input-with-toggle"> <input type="number" id="spouseSS" value="0"> <select id="spouseSSFreq"> <option value="annual" selected>Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <div class="input-group"> <label for="spouseSSStartAge">Spouse Social Security Start Age:</label> <input type="number" id="spouseSSStartAge" value="67"> </div> <div class="input-group"> <label for="spouseYOS">Spouse Years of Service:</label> <input type="number" id="spouseYOS" value="0"> </div> </fieldset>
            </div>
            <fieldset> <legend>Expenses & Debts</legend> <div class="input-group"> <label for="currentExpenses">Current Pre-Retirement Expenses (Today's $):</label> <div class="input-with-toggle"> <input type="number" id="currentExpenses" value="0" required> <select id="currentExpensesFreq"> <option value="annual">Annual</option> <option value="monthly" selected>Monthly</option> </select> </div> </div> <div class="input-group"> <label for="desiredRetirementSpending">Desired Retirement Lifestyle Spending (Today's $):</label> <div class="input-with-toggle"> <input type="number" id="desiredRetirementSpending" value="0" required> <select id="desiredRetirementSpendingFreq"> <option value="annual">Annual</option> <option value="monthly" selected>Monthly</option> </select> </div> </div> <hr> <p style="font-size: 0.9em; color: #555;">Enter debt payments (fixed amounts):</p> <div class="grid-container"> <div class="input-group"> <label for="mortgagePmt">Mortgage Payment:</label> <div class="input-with-toggle"> <input type="number" id="mortgagePmt" value="0"><select id="mortgagePmtFreq"><option value="monthly" selected>Monthly</option><option value="annual">Annual</option></select> </div> </div> <div class="input-group"> <label for="mortgageYears">Years Left:</label> <input type="number" id="mortgageYears" value="0"> </div> <div class="input-group"> <label for="carPmt">Car Payment:</label> <div class="input-with-toggle"><input type="number" id="carPmt" value="0"><select id="carPmtFreq"><option value="monthly" selected>Monthly</option><option value="annual">Annual</option></select></div> </div> <div class="input-group"> <label for="carYears">Years Left:</label> <input type="number" id="carYears" value="0"> </div> <div class="input-group"> <label for="schoolPmt">School Loans:</label> <div class="input-with-toggle"><input type="number" id="schoolPmt" value="0"><select id="schoolPmtFreq"><option value="monthly" selected>Monthly</option><option value="annual">Annual</option></select></div> </div> <div class="input-group"> <label for="schoolYears">Years Left:</label> <input type="number" id="schoolYears" value="0"> </div> <div class="input-group"> <label for="otherDebt1Pmt">Other Debt 1:</label> <div class="input-with-toggle"><input type="number" id="otherDebt1Pmt" value="0"><select id="otherDebt1PmtFreq"><option value="monthly" selected>Monthly</option><option value="annual">Annual</option></select></div> </div> <div class="input-group"> <label for="otherDebt1Years">Years Left:</label> <input type="number" id="otherDebt1Years" value="0"> </div> <div class="input-group"> <label for="otherDebt2Pmt">Other Debt 2:</label> <div class="input-with-toggle"><input type="number" id="otherDebt2Pmt" value="0"><select id="otherDebt2PmtFreq"><option value="monthly" selected>Monthly</option><option value="annual">Annual</option></select></div> </div> <div class="input-group"> <label for="otherDebt2Years">Years Left:</label> <input type="number" id="otherDebt2Years" value="0"> </div> <div class="input-group"> <label for="lifeInsPremiumClient">Client Life Ins. Premium:</label> <div class="input-with-toggle"><input type="number" id="lifeInsPremiumClient" value="0"><select id="lifeInsPremiumClientFreq"><option value="monthly" selected>Monthly</option><option value="annual">Annual</option></select></div> </div> <div class="input-group spouse-section"> <label for="lifeInsPremiumSpouse">Spouse Life Ins. Premium:</label> <div class="input-with-toggle"><input type="number" id="lifeInsPremiumSpouse" value="0"><select id="lifeInsPremiumSpouseFreq"><option value="monthly" selected>Monthly</option><option value="annual">Annual</option></select></div> </div> </div> </fieldset>
            <fieldset> <legend>Retirement Assets & Contributions</legend> <div class="grid-col-2"> <div> <h3>Client Assets</h3> <div class="input-group"> <label for="client401kBal">401k Balance ($):</label><input type="number" id="client401kBal" value="0"> <label for="client401kLabel" class="asset-detail-label">Account Type/Label:</label><input type="text" id="client401kLabel" placeholder=""> <label for="client401kInstitution" class="asset-detail-label">Financial Institution:</label><input type="text" id="client401kInstitution" placeholder=""> </div> <div class="input-group"> <label for="client401kContrib">Contribution ($):</label> <div class="input-with-toggle"> <input type="number" id="client401kContrib" value="0"> <select id="client401kContribFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <hr> <div class="input-group"> <label for="client457Bal">457 Balance ($):</label><input type="number" id="client457Bal" value="0"> <label for="client457Label" class="asset-detail-label">Account Type/Label:</label><input type="text" id="client457Label"> <label for="client457Institution" class="asset-detail-label">Financial Institution:</label><input type="text" id="client457Institution"> </div> <div class="input-group"> <label for="client457Contrib">Contribution ($):</label> <div class="input-with-toggle"> <input type="number" id="client457Contrib" value="0"> <select id="client457ContribFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <hr> <div class="input-group"> <label for="client403bBal">403b Balance ($):</label><input type="number" id="client403bBal" value="0"> <label for="client403bLabel" class="asset-detail-label">Account Type/Label:</label><input type="text" id="client403bLabel"> <label for="client403bInstitution" class="asset-detail-label">Financial Institution:</label><input type="text" id="client403bInstitution"> </div> <div class="input-group"> <label for="client403bContrib">Contribution ($):</label> <div class="input-with-toggle"> <input type="number" id="client403bContrib" value="0"> <select id="client403bContribFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <hr> <div class="input-group"> <label for="clientOtherBal">Other Account Balance ($):</label><input type="number" id="clientOtherBal" value="0"> <label for="clientOtherLabel" class="asset-detail-label">Account Type/Label:</label><input type="text" id="clientOtherLabel" placeholder=""> <label for="clientOtherInstitution" class="asset-detail-label">Financial Institution:</label><input type="text" id="clientOtherInstitution"> </div> <div class="input-group"> <label for="clientOtherContrib">Contribution ($):</label> <div class="input-with-toggle"> <input type="number" id="clientOtherContrib" value="0"> <select id="clientOtherContribFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> </div> <div class="spouse-section"> <h3>Spouse Assets</h3> <div class="input-group"> <label for="spouse401kBal">401k Balance ($):</label><input type="number" id="spouse401kBal" value="0"> <label for="spouse401kLabel" class="asset-detail-label">Account Type/Label:</label><input type="text" id="spouse401kLabel"> <label for="spouse401kInstitution" class="asset-detail-label">Financial Institution:</label><input type="text" id="spouse401kInstitution"> </div> <div class="input-group"> <label for="spouse401kContrib">Contribution ($):</label> <div class="input-with-toggle"> <input type="number" id="spouse401kContrib" value="0"> <select id="spouse401kContribFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <hr> <div class="input-group"> <label for="spouse457Bal">457 Balance ($):</label><input type="number" id="spouse457Bal" value="0"> <label for="spouse457Label" class="asset-detail-label">Account Type/Label:</label><input type="text" id="spouse457Label"> <label for="spouse457Institution" class="asset-detail-label">Financial Institution:</label><input type="text" id="spouse457Institution"> </div> <div class="input-group"> <label for="spouse457Contrib">Contribution ($):</label> <div class="input-with-toggle"> <input type="number" id="spouse457Contrib" value="0"> <select id="spouse457ContribFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <hr> <div class="input-group"> <label for="spouse403bBal">403b Balance ($):</label><input type="number" id="spouse403bBal" value="0"> <label for="spouse403bLabel" class="asset-detail-label">Account Type/Label:</label><input type="text" id="spouse403bLabel"> <label for="spouse403bInstitution" class="asset-detail-label">Financial Institution:</label><input type="text" id="spouse403bInstitution"> </div> <div class="input-group"> <label for="spouse403bContrib">Contribution ($):</label> <div class="input-with-toggle"> <input type="number" id="spouse403bContrib" value="0"> <select id="spouse403bContribFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> <hr> <div class="input-group"> <label for="spouseOtherBal">Other Account Balance ($):</label><input type="number" id="spouseOtherBal" value="0"> <label for="spouseOtherLabel" class="asset-detail-label">Account Type/Label:</label><input type="text" id="spouseOtherLabel"> <label for="spouseOtherInstitution" class="asset-detail-label">Financial Institution:</label><input type="text" id="spouseOtherInstitution"> </div> <div class="input-group"> <label for="spouseOtherContrib">Contribution ($):</label> <div class="input-with-toggle"> <input type="number" id="spouseOtherContrib" value="0"> <select id="spouseOtherContribFreq"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> </div> </div> </div> </fieldset>
            <fieldset> <legend>Rates & Assumptions</legend> <div class="grid-container"> <div class="input-group"> <label for="state">State of Residence:</label> <select id="state"> <option value="NA">N/A or No State Tax</option> <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option> </select> </div>
                <div class="input-group"> <label for="preRetirementReturn">Pre-Retirement Return Rate (%):</label> <input type="number" id="preRetirementReturn" value="7.0" step="0.1" required> </div>
                <div class="input-group"> <label for="postRetirementReturn">Post-Retirement Return Rate (%):</label> <input type="number" id="postRetirementReturn" value="5.0" step="0.1" required> </div>
                <div class="input-group"> <label for="inflationRate">General Inflation Rate (%):</label> <input type="number" id="inflationRate" value="2.5" step="0.1" required> </div>
                <div class="input-group"> <label for="workIncomeColaRate">Work Income COLA (%):</label> <input type="number" id="workIncomeColaRate" value="2.0" step="0.1" required> </div>
                <div class="input-group"> <label for="retirementIncomeColaRate">Retirement Income COLA (%):</label> <input type="number" id="retirementIncomeColaRate" value="1.5" step="0.1" required> </div>
            </div> <p style="font-size: 0.8em; color: #666; margin-top: 15px;"><strong>Disclaimer:</strong> Tax calculations are highly simplified estimates. Not financial advice.</p> </fieldset>
            <div class="action-buttons-container"> <button type="button" onclick="calculateRetirementProjection()">Calculate Projection</button> <button type="button" id="downloadPdfButton" onclick="downloadPDF()" disabled>Download Results as PDF</button> </div>
        </form>

        <div id="resultsArea"> <div id="summary-results" class="summary" style="display:none;"></div> <div class="output-toggle-container" style="display:none;"> <label for="outputFrequency">Display Table Values As:</label> <select id="outputFrequency" onchange="calculateRetirementProjection(true)"> <option value="annual">Annual</option> <option value="monthly">Monthly</option> </select> </div> <div id="output" style="overflow-x:auto;"> <table id="resultsTable" style="display:none;"> <thead> <tr> <th>Year</th><th>Client Age</th><th class="spouse-column">Spouse Age</th><th>Status</th><th>Beginning Assets ($)</th><th>Contributions ($)</th><th>Gross Income ($)</th><th>Gross Expenses ($)</th><th>Est. Taxes ($)</th><th>Net Cash Flow ($)</th><th>Withdrawals ($)</th><th>Investment Growth ($)</th><th>Ending Assets ($)</th> </tr> </thead> <tbody></tbody> </table> </div> <div id="chartContainer"> <canvas id="projectionChart"></canvas> </div> </div>
    </div>

    <script>
        // --- Globals ---
        window.jsPDF = window.jspdf.jsPDF;
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyTpvu1Qzxr_6dxHX1wqnsfW0qMUE_kmLsXoozVgwkRlnCnvJEMUODJJLJwzgP0z8pg/exec"; // <<<!!! REPLACE THIS WITH YOUR GOOGLE APPS SCRIPT WEB APP URL !!!>>>
        const ID_COLUMN_NAME_JS = "ClientNameID"; // Must match the header for client ID in your Google Sheet
        const allInputIds = [ 'clientNameId', 'singleClientMode', 'clientDOB', 'clientAge', 'clientIncome', 'clientIncomeFreq', 'clientRetirementAge', 'clientPension', 'clientPensionFreq', 'clientPensionStartAge', 'clientSS', 'clientSSFreq', 'clientSSStartAge', 'clientYOS', 'spouseDOB', 'spouseAge', 'spouseIncome', 'spouseIncomeFreq', 'spouseRetirementAge', 'spousePension', 'spousePensionFreq', 'spousePensionStartAge', 'spouseSS', 'spouseSSFreq', 'spouseSSStartAge', 'spouseYOS', 'currentExpenses', 'currentExpensesFreq', 'desiredRetirementSpending', 'desiredRetirementSpendingFreq', 'mortgagePmt', 'mortgagePmtFreq', 'mortgageYears', 'carPmt', 'carPmtFreq', 'carYears', 'schoolPmt', 'schoolPmtFreq', 'schoolYears', 'otherDebt1Pmt', 'otherDebt1PmtFreq', 'otherDebt1Years', 'otherDebt2Pmt', 'otherDebt2PmtFreq', 'otherDebt2Years', 'lifeInsPremiumClient', 'lifeInsPremiumClientFreq', 'lifeInsPremiumSpouse', 'lifeInsPremiumSpouseFreq', 'client401kBal', 'client401kLabel', 'client401kInstitution', 'client401kContrib', 'client401kContribFreq', 'client457Bal', 'client457Label', 'client457Institution', 'client457Contrib', 'client457ContribFreq', 'client403bBal', 'client403bLabel', 'client403bInstitution', 'client403bContrib', 'client403bContribFreq', 'clientOtherBal', 'clientOtherLabel', 'clientOtherInstitution', 'clientOtherContrib', 'clientOtherContribFreq', 'spouse401kBal', 'spouse401kLabel', 'spouse401kInstitution', 'spouse401kContrib', 'spouse401kContribFreq', 'spouse457Bal', 'spouse457Label', 'spouse457Institution', 'spouse457Contrib', 'spouse457ContribFreq', 'spouse403bBal', 'spouse403bLabel', 'spouse403bInstitution', 'spouse403bContrib', 'spouse403bContribFreq', 'spouseOtherBal', 'spouseOtherLabel', 'spouseOtherInstitution', 'spouseOtherContrib', 'spouseOtherContribFreq', 'state', 'preRetirementReturn', 'postRetirementReturn', 'inflationRate', 'workIncomeColaRate', 'retirementIncomeColaRate' ];
        let projectionChartInstance = null;
        let lastCalculationData = null;

        // --- Helper Functions ---
        function formatCurrency(value, outputFreq = 'annual', isAsset = false) { let displayValue = Number(value); if (isNaN(displayValue)) { return '$--'; } if (outputFreq === 'monthly' && !isAsset) { displayValue /= 12; } return displayValue.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: (outputFreq === 'monthly' && !isAsset ? 2:0), maximumFractionDigits: (outputFreq === 'monthly' && !isAsset ? 2:0) }); }
        function getAnnualValue(inputId, freqId) { const value = parseFloat(document.getElementById(inputId).value || 0); const freqElement = document.getElementById(freqId); if (!freqElement) { return value; } const freq = freqElement.value; return freq === 'monthly' ? value * 12 : value; }
        function calculateAge(dobString) { if (!dobString) return NaN; try { const birthDate = new Date(dobString); if (isNaN(birthDate.getTime())) return NaN; const today = new Date(); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; } return age >= 0 ? age : NaN; } catch (e) { return NaN; } }
        function displayMessage(message, type = 'info') { const msgArea = document.getElementById('message-area'); if (!message) { msgArea.textContent = ''; msgArea.className = 'message'; msgArea.style.display = 'none'; return; } msgArea.textContent = message; msgArea.className = `message ${type}`; msgArea.style.display = 'block'; if (type === 'info' || type === 'success') { setTimeout(() => { if (msgArea.textContent === message) { msgArea.textContent = ''; msgArea.className = 'message'; msgArea.style.display = 'none'; } }, 6000); } }
        const estimatedStateTaxRates = { AL: 0.04, AK: 0.00, AZ: 0.03, AR: 0.05, CA: 0.08, CO: 0.045, CT: 0.05, DE: 0.05, FL: 0.00, GA: 0.05, HI: 0.07, ID: 0.06, IL: 0.05, IN: 0.03, IA: 0.06, KS: 0.05, KY: 0.05, LA: 0.04, ME: 0.06, MD: 0.07, MA: 0.05, MI: 0.04, MN: 0.07, MS: 0.05, MO: 0.05, MT: 0.06, NE: 0.06, NV: 0.00, NH: 0.00, NJ: 0.07, NM: 0.05, NY: 0.07, NC: 0.05, ND: 0.02, OH: 0.04, OK: 0.05, OR: 0.09, PA: 0.03, RI: 0.05, SC: 0.06, SD: 0.00, TN: 0.00, TX: 0.00, UT: 0.05, VT: 0.07, VA: 0.05, WA: 0.00, WV: 0.05, WI: 0.06, WY: 0.00, NA: 0.00 };
        const estimatedFederalTaxRate = 0.15;

        // --- Single Client Mode Toggle ---
        function toggleSpouseFields() { const singleClientMode = document.getElementById('singleClientMode').checked; document.querySelectorAll('.spouse-section').forEach(el => el.classList.toggle('hidden', singleClientMode)); document.querySelectorAll('.spouse-column').forEach(el => el.classList.toggle('hidden', singleClientMode)); document.querySelectorAll('.spouse-section input, .spouse-section select').forEach(input => input.disabled = singleClientMode); clearResults(); }

        // --- Main Calculation Function ---
        function calculateRetirementProjection(isRedraw = false) {
            const singleClientMode = document.getElementById('singleClientMode').checked;
            if (!isRedraw) {
                document.getElementById('downloadPdfButton').disabled = true;
                clearResults();
                displayMessage("Calculating...", 'info');
                setTimeout(() => {
                    try {
                        // Step 1: Get Inputs
                        const clientDOBValue = document.getElementById('clientDOB').value;
                        const initialClientAge = parseInt(document.getElementById('clientAge').value) || calculateAge(clientDOBValue);
                        let initialSpouseAge = NaN; if (!singleClientMode) { const spouseDOBValue = document.getElementById('spouseDOB').value; initialSpouseAge = parseInt(document.getElementById('spouseAge').value) || calculateAge(spouseDOBValue); }
                        const clientIncomeToday = getAnnualValue('clientIncome', 'clientIncomeFreq');
                        const clientRetirementAge = parseInt(document.getElementById('clientRetirementAge').value);
                        const clientPensionInput = getAnnualValue('clientPension', 'clientPensionFreq');
                        const clientPensionStartAge = parseInt(document.getElementById('clientPensionStartAge').value || 999);
                        const clientSSInput = getAnnualValue('clientSS', 'clientSSFreq');
                        const clientSSStartAge = parseInt(document.getElementById('clientSSStartAge').value || 999);
                        let spouseIncomeToday = 0, spouseRetirementAge = 999, spousePensionInput = 0, spousePensionStartAge = 999, spouseSSInput = 0, spouseSSStartAge = 999, spouseContributions = 0;
                        if (!singleClientMode) { spouseIncomeToday = getAnnualValue('spouseIncome', 'spouseIncomeFreq'); spouseRetirementAge = parseInt(document.getElementById('spouseRetirementAge').value); spousePensionInput = getAnnualValue('spousePension', 'spousePensionFreq'); spousePensionStartAge = parseInt(document.getElementById('spousePensionStartAge').value || 999); spouseSSInput = getAnnualValue('spouseSS', 'spouseSSFreq'); spouseSSStartAge = parseInt(document.getElementById('spouseSSStartAge').value || 999); spouseContributions = getAnnualValue('spouse401kContrib', 'spouse401kContribFreq') + getAnnualValue('spouse457Contrib', 'spouse457ContribFreq') + getAnnualValue('spouse403bContrib', 'spouse403bContribFreq') + getAnnualValue('spouseOtherContrib', 'spouseOtherContribFreq'); }
                        const currentExpensesToday = getAnnualValue('currentExpenses', 'currentExpensesFreq');
                        const desiredRetirementSpendingToday = getAnnualValue('desiredRetirementSpending', 'desiredRetirementSpendingFreq');
                        const debts = [ { pmt: getAnnualValue('mortgagePmt', 'mortgagePmtFreq'), years: parseInt(document.getElementById('mortgageYears').value || 0)}, { pmt: getAnnualValue('carPmt', 'carPmtFreq'), years: parseInt(document.getElementById('carYears').value || 0)}, { pmt: getAnnualValue('schoolPmt', 'schoolPmtFreq'), years: parseInt(document.getElementById('schoolYears').value || 0)}, { pmt: getAnnualValue('otherDebt1Pmt', 'otherDebt1PmtFreq'), years: parseInt(document.getElementById('otherDebt1Years').value || 0)}, { pmt: getAnnualValue('otherDebt2Pmt', 'otherDebt2PmtFreq'), years: parseInt(document.getElementById('otherDebt2Years').value || 0)}, ].filter(d => d.pmt > 0 && d.years > 0);
                        const clientInsPremium = getAnnualValue('lifeInsPremiumClient', 'lifeInsPremiumClientFreq');
                        const spouseInsPremium = singleClientMode ? 0 : getAnnualValue('lifeInsPremiumSpouse', 'lifeInsPremiumSpouseFreq');
                        const clientContributions = getAnnualValue('client401kContrib', 'client401kContribFreq') + getAnnualValue('client457Contrib', 'client457ContribFreq') + getAnnualValue('client403bContrib', 'client403bContribFreq') + getAnnualValue('clientOtherContrib', 'clientOtherContribFreq');
                        let totalAssets = parseFloat(document.getElementById('client401kBal').value || 0) + parseFloat(document.getElementById('client457Bal').value || 0) + parseFloat(document.getElementById('client403bBal').value || 0) + parseFloat(document.getElementById('clientOtherBal').value || 0);
                        if (!singleClientMode) { totalAssets += parseFloat(document.getElementById('spouse401kBal').value || 0) + parseFloat(document.getElementById('spouse457Bal').value || 0) + parseFloat(document.getElementById('spouse403bBal').value || 0) + parseFloat(document.getElementById('spouseOtherBal').value || 0); }
                        const stateAbbr = document.getElementById('state').value;
                        const preRetRate = parseFloat(document.getElementById('preRetirementReturn').value) / 100;
                        const postRetRate = parseFloat(document.getElementById('postRetirementReturn').value) / 100;
                        const inflationRate = parseFloat(document.getElementById('inflationRate').value) / 100;
                        const workIncomeColaRate = parseFloat(document.getElementById('workIncomeColaRate').value) / 100;
                        const retirementIncomeColaRate = parseFloat(document.getElementById('retirementIncomeColaRate').value) / 100;

                        // Validation
                        const requiredClientNumeric = [initialClientAge, clientRetirementAge, preRetRate, postRetRate, inflationRate, workIncomeColaRate, retirementIncomeColaRate, totalAssets, currentExpensesToday, desiredRetirementSpendingToday];
                        if (requiredClientNumeric.some(isNaN)) { throw new Error("Key client numeric inputs are invalid."); }
                        if (clientRetirementAge <= initialClientAge) { throw new Error("Client Retirement Age must be > Current Age."); }
                        if (!singleClientMode) { const requiredSpouseNumeric = [initialSpouseAge, spouseRetirementAge]; if (requiredSpouseNumeric.some(isNaN)) { throw new Error("Key spouse numeric inputs are invalid."); } if (spouseRetirementAge <= initialSpouseAge) { throw new Error("Spouse Retirement Age must be > Current Age."); } }

                        lastCalculationData = { yearlyData: [], summary: {}, chartData: {} };
                        let currentYear = new Date().getFullYear();
                        let cAge = initialClientAge; let sAge = initialSpouseAge;
                        const endYear = currentYear + (100 - initialClientAge);
                        debts.forEach(d => d.payoffYear = currentYear + d.years - 1);
                        let summary = { ranOutAtClientAge: null, finalBalance: 0, lastCoveredClientAge: null };
                        let currentClientPensionVal = 0; let clientPensionStarted = false; let currentClientSSVal = 0; let clientSSStarted = false; let currentSpousePensionVal = 0; let spousePensionStarted = false; let currentSpouseSSVal = 0; let spouseSSStarted = false;
                        let chartLabels = [], chartGrossIncome = [], chartGrossExpenses = [], chartNetCashFlow = [], chartEndingAssets = [], chartTaxes = [];

                        // Loop
                        for (let year = currentYear; year <= endYear; year++, cAge++, sAge = singleClientMode ? null : (sAge !== null ? sAge + 1 : null) ) {
                            if (year > currentYear + 120) break;
                            let beginningBalance = totalAssets;
                            let contributionsThisYear = 0, totalIncomeThisYear = 0, totalExpensesThisYear = 0, estimatedTaxesThisYear = 0, netCashFlow = 0, actualWithdrawal = 0, growth = 0, status = "";
                            let yearsFromToday = year - currentYear;

                            let clientIsRetired = (cAge >= clientRetirementAge);
                            let spouseIsRetired = singleClientMode ? true : (sAge >= spouseRetirementAge);
                            let bothEffectivelyRetired = clientIsRetired && spouseIsRetired;
                            let currentRate = bothEffectivelyRetired ? postRetRate : preRetRate;
                            status = clientIsRetired ? (spouseIsRetired || singleClientMode ? (singleClientMode ? "Retirement (Single)" : "Both Retired") : "Client Retired, Spouse Working") : (spouseIsRetired && !singleClientMode ? "Spouse Retired, Client Working" : "Pre-Retirement");
                            if (singleClientMode && !clientIsRetired) status = "Pre-Retirement (Single)";

                            if (!clientIsRetired) contributionsThisYear += clientContributions;
                            if (!singleClientMode && !spouseIsRetired) contributionsThisYear += spouseContributions;

                            totalIncomeThisYear = 0;
                            // Work Income (uses workIncomeColaRate)
                            if (cAge < clientRetirementAge) { totalIncomeThisYear += clientIncomeToday * Math.pow(1 + workIncomeColaRate, yearsFromToday); }
                            if (!singleClientMode && sAge !== null && sAge < spouseRetirementAge) { totalIncomeThisYear += spouseIncomeToday * Math.pow(1 + workIncomeColaRate, yearsFromToday); }

                            // Pension & SS - Corrected COLA Application
                            // Client Pension
                            if (cAge >= clientPensionStartAge) {
                                if (!clientPensionStarted) { currentClientPensionVal = clientPensionInput; clientPensionStarted = true; } // Use input value directly for the first year
                                else { currentClientPensionVal *= (1 + retirementIncomeColaRate); } // COLA on subsequent years
                                totalIncomeThisYear += currentClientPensionVal;
                            }
                            // Client SS
                            if (cAge >= clientSSStartAge) {
                                if (!clientSSStarted) { currentClientSSVal = clientSSInput; clientSSStarted = true; }
                                else { currentClientSSVal *= (1 + retirementIncomeColaRate); }
                                totalIncomeThisYear += currentClientSSVal;
                            }
                            // Spouse Pension & SS
                            if (!singleClientMode && sAge !== null) {
                                if (sAge >= spousePensionStartAge) {
                                    if (!spousePensionStarted) { currentSpousePensionVal = spousePensionInput; spousePensionStarted = true; }
                                    else { currentSpousePensionVal *= (1 + retirementIncomeColaRate); }
                                    totalIncomeThisYear += currentSpousePensionVal;
                                }
                                if (sAge >= spouseSSStartAge) {
                                    if (!spouseSSStarted) { currentSpouseSSVal = spouseSSInput; spouseSSStarted = true; }
                                    else { currentSpouseSSVal *= (1 + retirementIncomeColaRate); }
                                    totalIncomeThisYear += currentSpouseSSVal;
                                }
                            }

                            let baseLifestyleSpending = bothEffectivelyRetired ? desiredRetirementSpendingToday : currentExpensesToday;
                            totalExpensesThisYear += baseLifestyleSpending * Math.pow(1 + inflationRate, yearsFromToday);
                            debts.forEach(debt => { if (year <= debt.payoffYear) totalExpensesThisYear += debt.pmt; });
                            totalExpensesThisYear += clientInsPremium; if (!singleClientMode) totalExpensesThisYear += spouseInsPremium;

                            estimatedTaxesThisYear = totalIncomeThisYear * (estimatedFederalTaxRate + (estimatedStateTaxRates[stateAbbr] || 0));
                            netCashFlow = totalIncomeThisYear - totalExpensesThisYear - contributionsThisYear - estimatedTaxesThisYear;
                            let balanceBeforeGrowth = beginningBalance + contributionsThisYear;
                            growth = balanceBeforeGrowth * currentRate;
                            let balanceAfterGrowth = balanceBeforeGrowth + growth;
                            let neededFromSavings = (netCashFlow < 0) ? Math.abs(netCashFlow) : 0;
                            actualWithdrawal = (neededFromSavings > 0) ? Math.min(neededFromSavings, balanceAfterGrowth) : 0;
                            totalAssets = balanceAfterGrowth - actualWithdrawal;
                            if (totalAssets < 0) totalAssets = 0;
                            let ranOutThisYear = (neededFromSavings > 0 && actualWithdrawal < neededFromSavings);
                            if (ranOutThisYear && summary.ranOutAtClientAge === null) summary.ranOutAtClientAge = cAge;
                            if (summary.ranOutAtClientAge === null) summary.lastCoveredClientAge = cAge;

                            lastCalculationData.yearlyData.push({ year, cAge, sAge: (singleClientMode ? null : sAge), status, beginningBalance, contributionsThisYear, totalIncomeThisYear, totalExpensesThisYear, estimatedTaxesThisYear, netCashFlow, actualWithdrawal, growth, totalAssets, ranOutThisYear });
                            chartLabels.push(year); chartGrossIncome.push(totalIncomeThisYear); chartGrossExpenses.push(totalExpensesThisYear); chartNetCashFlow.push(netCashFlow); chartEndingAssets.push(totalAssets); chartTaxes.push(estimatedTaxesThisYear);
                        } // End Loop

                        lastCalculationData.summary = summary;
                        lastCalculationData.chartData = { chartLabels, chartGrossIncome, chartGrossExpenses, chartNetCashFlow, chartEndingAssets, chartTaxes };
                        populateTableFromStoredData();
                        renderProjectionChart(chartLabels, chartGrossIncome, chartGrossExpenses, chartNetCashFlow, chartEndingAssets, chartTaxes);
                        document.getElementById('chartContainer').style.display = 'block';
                        document.getElementById('downloadPdfButton').disabled = false;
                        document.querySelector('.output-toggle-container').style.display = 'block';
                        displayMessage('Calculation Complete.', 'success');
                    } catch (error) { console.error("Calculation Error:", error); displayMessage(`Calculation Error: ${error.message}`, 'error'); clearResults(); }
                }, 10);
            } else if (lastCalculationData) { populateTableFromStoredData(); }
        }

        // --- Populate Table from Stored Data ---
        function populateTableFromStoredData() { if (!lastCalculationData || !lastCalculationData.yearlyData) return; const singleClientMode = document.getElementById('singleClientMode').checked; const outputFreq = document.getElementById('outputFrequency').value; const tbody = document.getElementById('resultsTable').getElementsByTagName('tbody')[0]; tbody.innerHTML = ''; lastCalculationData.yearlyData.forEach(rowData => { const newRow = tbody.insertRow(); if (rowData.status.toLowerCase().includes("pre-retirement")) { newRow.classList.add('pre-retirement-row'); } else { newRow.classList.add('retirement-row'); } newRow.insertCell().textContent = rowData.year; newRow.insertCell().textContent = rowData.cAge; const spouseAgeCell = newRow.insertCell(); spouseAgeCell.textContent = singleClientMode ? 'N/A' : rowData.sAge; spouseAgeCell.classList.toggle('hidden', singleClientMode); const statusCell = newRow.insertCell(); statusCell.textContent = rowData.status; statusCell.classList.add('status-col'); newRow.insertCell().textContent = formatCurrency(rowData.beginningBalance, outputFreq, true); newRow.insertCell().textContent = formatCurrency(rowData.contributionsThisYear, outputFreq); newRow.insertCell().textContent = formatCurrency(rowData.totalIncomeThisYear, outputFreq); newRow.insertCell().textContent = formatCurrency(rowData.totalExpensesThisYear, outputFreq); newRow.insertCell().textContent = formatCurrency(rowData.estimatedTaxesThisYear, outputFreq); const netCashFlowCell = newRow.insertCell(); netCashFlowCell.textContent = formatCurrency(rowData.netCashFlow, outputFreq); netCashFlowCell.classList.add(rowData.netCashFlow >= 0 ? 'positive' : 'negative'); newRow.insertCell().textContent = formatCurrency(rowData.actualWithdrawal, outputFreq); newRow.insertCell().textContent = formatCurrency(rowData.growth, outputFreq, true); const endingBalCell = newRow.insertCell(); endingBalCell.textContent = formatCurrency(rowData.totalAssets, outputFreq, true); if (rowData.ranOutThisYear || (rowData.totalAssets <= 0 && rowData.beginningBalance > 0)) endingBalCell.classList.add('negative'); }); const summary = lastCalculationData.summary; const summaryDiv = document.getElementById('summary-results'); summaryDiv.innerHTML = `<h3>Projection Summary:</h3>`; if (summary.ranOutAtClientAge !== null) { summaryDiv.innerHTML += `<p class="negative" style="font-weight:bold;">Funds are projected to be depleted around Client Age ${summary.ranOutAtClientAge}.</p>`; if(summary.lastCoveredClientAge) { summaryDiv.innerHTML += `<p>Needs were fully covered up to Client Age ${summary.lastCoveredClientAge}.</p>`; } } else { summaryDiv.innerHTML += `<p class="positive" style="font-weight:bold;">Funds are projected to last until at least Client Age ${summary.lastCoveredClientAge || lastCalculationData.yearlyData[lastCalculationData.yearlyData.length-1].cAge} (based on assumptions).</p>`; summaryDiv.innerHTML += `<p>Projected Final Balance: ${formatCurrency(summary.finalBalance, 'annual', true)}</p>`; } summaryDiv.style.display = 'block'; document.getElementById('resultsTable').style.display = 'table'; }
        // --- Chart Rendering Function ---
        function renderProjectionChart(labels, incomeData, expensesData, cashFlowData, assetsData, taxesData) { const ctx = document.getElementById('projectionChart').getContext('2d'); if (projectionChartInstance) { projectionChartInstance.destroy(); } projectionChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Ending Assets ($)', data: assetsData, borderColor: 'rgb(25, 135, 84)', backgroundColor: 'rgba(25, 135, 84, 0.1)', tension: 0.1, yAxisID: 'yAssets', borderWidth: 2 }, { label: 'Gross Income ($)', data: incomeData, borderColor: 'rgb(13, 202, 240)', backgroundColor: 'rgba(13, 202, 240, 0.1)', tension: 0.1, yAxisID: 'yOther', hidden: false }, { label: 'Gross Expenses ($)', data: expensesData, borderColor: 'rgb(220, 53, 69)', backgroundColor: 'rgba(220, 53, 69, 0.1)', tension: 0.1, yAxisID: 'yOther', hidden: false }, { label: 'Net Cash Flow ($)', data: cashFlowData, borderColor: 'rgb(13, 110, 253)', backgroundColor: 'rgba(13, 110, 253, 0.1)', tension: 0.1, yAxisID: 'yOther', borderDash: [5, 5], hidden: false }, { label: 'Estimated Taxes ($)', data: taxesData, borderColor: 'rgb(255, 193, 7)', backgroundColor: 'rgba(255, 193, 7, 0.1)', tension: 0.1, yAxisID: 'yOther', hidden: true } ] }, options: { responsive: true, maintainAspectRatio: true, interaction: { mode: 'index', intersect: false, }, plugins: { title: { display: true, text: 'Retirement Projection Overview' }, tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { const isAssetDataset = context.dataset.yAxisID === 'yAssets'; label += formatCurrency(context.parsed.y, document.getElementById('outputFrequency').value, isAssetDataset); } return label; } } }, legend: { position: 'top', labels: { padding: 15 } } }, scales: { x: { display: true, title: { display: true, text: 'Year' } }, yAssets: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Total Assets ($)' }, ticks: { callback: value => formatCurrency(value, 'annual', true) } }, yOther: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Annual Amounts ($)' }, ticks: { callback: value => formatCurrency(value, 'annual', false) }, grid: { drawOnChartArea: false, } } } } }); }
        // --- PDF Download Function ---
        function downloadPDF() { const summaryDiv = document.getElementById('summary-results'); const resultsTable = document.getElementById('resultsTable'); const clientName = document.getElementById('clientNameId').value.trim() || "Unnamed_Client"; if (!resultsTable || resultsTable.rows.length <= 1) { displayMessage("No results to download. Please calculate first.", 'error'); return; } displayMessage("Generating PDF...", 'info'); try { const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' }); const title = `Retirement Projection Report: ${clientName === 'Unnamed_Client' ? 'Unnamed Client' : clientName}`; const generatedDate = `Generated: ${new Date().toLocaleDateString()}`; const disclaimer = "Disclaimer: Projections are estimates based on inputs and simplified assumptions (esp. taxes). Not financial advice."; doc.setFontSize(16); doc.text(title, doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' }); doc.setFontSize(10); doc.text(generatedDate, doc.internal.pageSize.getWidth() / 2, 55, { align: 'center' }); const summaryLines = summaryDiv.innerText.split('\n').filter(line => line.trim() !== ''); doc.setFontSize(11); let summaryStartY = 80; doc.text(summaryLines, 40, summaryStartY); let summaryEndY = summaryStartY + (summaryLines.length * 12); const tableStartY = summaryEndY + 20; doc.autoTable({ html: '#resultsTable', startY: tableStartY, theme: 'grid', styles: { fontSize: 7, cellPadding: 2, halign: 'right' }, headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold', halign: 'center' }, columnStyles: { 3: { halign: 'left' } }, margin: { top: 70, right: 30, bottom: 40, left: 30 }, didParseCell: function (data) { if (data.cell.raw && data.cell.raw.classList) { if (data.cell.raw.classList.contains('negative')) data.cell.styles.textColor = [255, 0, 0]; else if (data.cell.raw.classList.contains('positive')) data.cell.styles.textColor = [0, 128, 0]; } if (!isNaN(Number(data.cell.text)) && data.column.index !== 3) data.cell.styles.halign = 'right'; } }); const pageCount = doc.internal.getNumberOfPages(); for (let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150); doc.text(disclaimer, 30, doc.internal.pageSize.getHeight() - 20); doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.getWidth() - 70, doc.internal.pageSize.getHeight() - 20); } const safeClientName = clientName.replace(/[^a-z0-9]/gi, '_').toLowerCase(); doc.save(`retirement_projection_${safeClientName}.pdf`); displayMessage("PDF Generated.", 'success'); } catch (error) { console.error("PDF Generation Error:", error); displayMessage(`PDF Generation Error: ${error.message}`, 'error'); } }
        // --- Client Data Management Functions ---
        function saveClientData() { displayMessage(''); const clientName = document.getElementById('clientNameId').value.trim(); if (!clientName) { displayMessage("Please enter a unique Client Name/ID to save.", 'error'); return; } const clientData = {}; allInputIds.forEach(id => { const element = document.getElementById(id); if (element) { if (element.type === 'checkbox') clientData[id] = element.checked; else clientData[id] = element.value; }}); try { fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "saveClient", clientData: { ...clientData, [ID_COLUMN_NAME_JS]: clientName } }), redirect: 'follow' }).then(response => response.json()).then(data => { if (data.success) { displayMessage(data.message || `Data saved for client: ${clientName}`, 'success'); populateClientList(); } else { throw new Error(data.error || "Unknown error saving data."); } }).catch(error => { console.error("Error saving client data:", error); displayMessage(`Error saving data: ${error.message}`, 'error'); }); } catch (e) { displayMessage("Error saving data. Client-side issue.", 'error'); } }
        function loadClientData() { displayMessage(''); const clientName = document.getElementById('savedClients').value; if (!clientName) { displayMessage("Please select a client to load.", 'error'); return; } displayMessage("Loading data...", 'info'); fetch(`${APPS_SCRIPT_URL}?action=loadClient&clientNameId=${encodeURIComponent(clientName)}`, { method: 'GET', mode: 'cors' }).then(response => response.json()).then(data => { if (data.error) { throw new Error(data.error); } if (data.clientData) { allInputIds.forEach(id => { const element = document.getElementById(id); if (element && data.clientData.hasOwnProperty(id)) { if (element.type === 'checkbox') element.checked = (String(data.clientData[id]).toLowerCase() === 'true' || data.clientData[id] === true); else element.value = data.clientData[id]; }}); const clientNameIdField = document.getElementById('clientNameId'); if (clientNameIdField && data.clientData[ID_COLUMN_NAME_JS]) { clientNameIdField.value = data.clientData[ID_COLUMN_NAME_JS]; } toggleSpouseFields(); triggerAgeCalculations(); clearResults(); displayMessage(`Data loaded for client: ${clientName}`, 'success'); } else { displayMessage(`No data found for client: ${clientName}`, 'info'); } }).catch(error => { console.error("Error loading client data:", error); displayMessage(`Error loading data: ${error.message}`, 'error'); }); }
        function deleteClientData() { displayMessage(''); const clientName = document.getElementById('savedClients').value; if (!clientName) { displayMessage("Please select a client to delete.", 'error'); return; } if (confirm(`DELETE saved data for client: ${clientName}? This cannot be undone.`)) { displayMessage("Deleting data...", 'info'); fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "deleteClient", clientNameId: clientName }), redirect: 'follow' }).then(response => response.json()).then(data => { if (data.success) { displayMessage(data.message || `Data deleted for client: ${clientName}`, 'success'); populateClientList(); if(document.getElementById('clientNameId').value === clientName) { document.getElementById('retirementForm').reset(); document.getElementById('clientNameId').value = ''; toggleSpouseFields(); clearResults(); } } else { throw new Error(data.error || "Unknown error deleting data."); } }).catch(error => { console.error("Error deleting client data:", error); displayMessage(`Error deleting data: ${error.message}`, 'error'); }); } }
        function populateClientList() { const selectElement = document.getElementById('savedClients'); const currentSelection = selectElement.value; selectElement.innerHTML = '<option value="">-- Select Client --</option>'; fetch(`${APPS_SCRIPT_URL}?action=listClients`, { method: 'GET', mode: 'cors' }).then(response => response.json()).then(data => { if (data.error) { throw new Error(data.error); } if (data.clients && Array.isArray(data.clients)) { data.clients.forEach(clientName => { const option = document.createElement('option'); option.value = clientName; option.textContent = clientName; selectElement.appendChild(option); }); if(data.clients.includes(currentSelection)) { selectElement.value = currentSelection; } } }).catch(error => { console.error("Error populating client list:", error); displayMessage("Could not load client list from server.", 'error'); }); }
        function clearResults() { const resultsTable = document.getElementById('resultsTable'); const tbody = resultsTable.getElementsByTagName('tbody')[0]; if(tbody) tbody.innerHTML = ''; resultsTable.style.display = 'none'; document.getElementById('summary-results').style.display = 'none'; document.getElementById('summary-results').innerHTML = ''; document.getElementById('chartContainer').style.display = 'none'; document.querySelector('.output-toggle-container').style.display = 'none'; if (projectionChartInstance) { projectionChartInstance.destroy(); projectionChartInstance = null; } document.getElementById('downloadPdfButton').disabled = true; lastCalculationData = null; }
        function triggerAgeCalculations() { const clientDOB = document.getElementById('clientDOB').value; const clientAgeEl = document.getElementById('clientAge'); clientAgeEl.value = calculateAge(clientDOB) || ''; const spouseDOB = document.getElementById('spouseDOB').value; const spouseAgeEl = document.getElementById('spouseAge'); if(!document.getElementById('singleClientMode').checked) { spouseAgeEl.value = calculateAge(spouseDOB) || ''; } else { spouseAgeEl.value = '';} }

        // --- Event Listeners & Initial Setup ---
        document.getElementById('clientDOB')?.addEventListener('change', triggerAgeCalculations);
        document.getElementById('spouseDOB')?.addEventListener('change', triggerAgeCalculations);
        window.addEventListener('load', () => { populateClientList(); triggerAgeCalculations(); toggleSpouseFields(); displayMessage("Ready. Fill in inputs or load a saved client.", 'info'); });

    </script>

</body>
</html>
